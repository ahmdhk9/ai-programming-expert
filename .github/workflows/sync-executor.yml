name: âš¡ Sync Executor - Real-time Error Detection & Correction

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sync-detection-correction:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      checks: write

    steps:
      - name: âœ… Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ” Phase 1: Error Detection
        id: detect
        run: |
          cd scripts
          node error-detector.js
          
          # Check if errors exist
          ERRORS=$(jq '.summary.totalErrors' ../ERROR_DETECTION_REPORT.json)
          echo "detected_errors=$ERRORS" >> $GITHUB_OUTPUT

      - name: ğŸ”§ Phase 2: Auto-Correction (if errors found)
        if: steps.detect.outputs.detected_errors > 0
        id: correct
        run: |
          cd scripts
          node auto-corrector.js
          
          CORRECTIONS=$(jq '.totalCorrections' ../corrections-log.json 2>/dev/null || echo "0")
          echo "corrections_made=$CORRECTIONS" >> $GITHUB_OUTPUT

      - name: ğŸ”— Phase 3: Algorithm Linking
        id: link
        run: |
          cd scripts
          node algorithm-linker.js
          
          SCORE=$(jq '.summary.consistencyScore' ../ALGORITHM_LINKING_REPORT.json)
          echo "consistency_score=$SCORE" >> $GITHUB_OUTPUT

      - name: âš¡ Phase 4: Synchronous Execution
        id: sync
        run: |
          cat > sync-run.js << 'EOF'
          const ErrorDetector = require('./error-detector');
          const AutoCorrector = require('./auto-corrector');

          async function syncExecute() {
            console.log('âš¡ Starting synchronized execution...\n');

            // 1. Detect
            console.log('1ï¸âƒ£ Detection Phase...');
            const detector = new ErrorDetector();
            const detected = detector.detectAll();
            console.log(`   âœ… Found ${detected.summary.totalErrors} errors\n`);

            // 2. Correct
            if (detected.summary.totalErrors > 0) {
              console.log('2ï¸âƒ£ Correction Phase...');
              const corrector = new AutoCorrector();
              const corrected = corrector.correctAll();
              console.log(`   âœ… Fixed ${corrected.totalCorrections} issues\n`);

              // 3. Re-detect to verify
              console.log('3ï¸âƒ£ Verification Phase...');
              const detector2 = new ErrorDetector();
              const verified = detector2.detectAll();
              console.log(`   âœ… Remaining errors: ${verified.summary.totalErrors}\n`);

              return verified.summary.totalErrors === 0;
            }

            return true;
          }

          syncExecute().then(success => {
            console.log(success ? 'âœ… Sync execution PASSED' : 'âŒ Sync execution FAILED');
            process.exit(success ? 0 : 1);
          });
          EOF
          
          node sync-run.js

      - name: ğŸ“Š Phase 5: Verification Report
        run: |
          cat > SYNC_EXECUTION_REPORT.md << 'EOF'
          # âš¡ Synchronous Execution Report
          
          **Timestamp:** $(date -u +'%Y-%m-%dT%H:%M:%SZ')
          
          ## Phases Executed:
          
          1. âœ… **Detection Phase**
             - Scanned all files
             - Identified errors and warnings
             
          2. âœ… **Correction Phase**
             - Applied auto-fixes
             - Enforced standards
             
          3. âœ… **Linking Phase**
             - Connected algorithms
             - Verified consistency
             
          4. âœ… **Synchronization Phase**
             - Executed in real-time
             - Maintained order
             
          5. âœ… **Verification Phase**
             - Re-detected issues
             - Confirmed resolution
          
          ## Status: COMPLETE
          
          All errors detected and corrected synchronously.
          No issues remain.
          
          EOF
          
          cat SYNC_EXECUTION_REPORT.md

      - name: ğŸ”„ Phase 6: Commit Corrections
        if: steps.correct.outputs.corrections_made > 0
        run: |
          git config user.name "Sync Executor"
          git config user.email "sync@executor.dev"
          
          git add -A
          
          if ! git diff --cached --quiet; then
            git commit -m "âš¡ Auto: Sync-detected and corrected issues - Consistency: ${{ steps.link.outputs.consistency_score }}%"
            git push origin main
          fi

      - name: ğŸ“‹ Final Report
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš¡ SYNC EXECUTOR COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ” Detection: ${{ steps.detect.outputs.detected_errors }} errors"
          echo "ğŸ”§ Corrections: ${{ steps.correct.outputs.corrections_made }} fixes"
          echo "ğŸ”— Consistency: ${{ steps.link.outputs.consistency_score }}%"
          echo ""
          echo "âœ… Status: ALL SYNCHRONIZED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
