name: ðŸ“š Auto-Document Changes

on:
  push:
    branches: [ main ]

jobs:
  document-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“ Extract Commit Information
        id: commit-info
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_TIME=$(git log -1 --pretty=%aI)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          
          echo "sha=${COMMIT_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "message=${COMMIT_MSG}" >> $GITHUB_OUTPUT
          echo "time=${COMMIT_TIME}" >> $GITHUB_OUTPUT
          echo "author=${COMMIT_AUTHOR}" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Get Changed Files
        id: changed-files
        run: |
          CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ðŸ“š Update CHANGELOG
        run: |
          cat > CHANGELOG_ENTRY.md << 'EOF'
          ## [${{ steps.commit-info.outputs.time }}]

          **Commit:** `${{ steps.commit-info.outputs.sha }}`
          **Author:** ${{ steps.commit-info.outputs.author }}
          **Message:** ${{ steps.commit-info.outputs.message }}

          **Files Changed:**
          ${{ steps.changed-files.outputs.files }}

          **Status:** âœ… Deployed

          ---

          EOF
          
          if [ -f CHANGELOG.md ]; then
            cat CHANGELOG_ENTRY.md CHANGELOG.md > CHANGELOG_TEMP.md
            mv CHANGELOG_TEMP.md CHANGELOG.md
          else
            cp CHANGELOG_ENTRY.md CHANGELOG.md
          fi
          
          rm CHANGELOG_ENTRY.md

      - name: ðŸ“ Update Documentation Registry
        run: |
          cat >> DOCUMENTATION_REGISTRY.md << 'EOF'
          
          ### ${{ steps.commit-info.outputs.sha }}
          - **Date:** ${{ steps.commit-info.outputs.time }}
          - **Author:** ${{ steps.commit-info.outputs.author }}
          - **Commit:** ${{ steps.commit-info.outputs.message }}
          - **Files:** See CHANGELOG.md
          - **Tracked:** Yes âœ…
          
          EOF

      - name: ðŸ“Š Log to Deployment Report
        run: |
          cat >> deployment-tracking.log << 'EOF'
          
          === Deployment Record ===
          Timestamp: ${{ steps.commit-info.outputs.time }}
          Commit: ${{ steps.commit-info.outputs.sha }}
          Branch: main
          Status: âœ…
          
          EOF

      - name: ðŸ”„ Commit Documentation Updates
        run: |
          git config user.name "Replit Agent"
          git config user.email "agent@replit.dev"
          
          git add CHANGELOG.md DOCUMENTATION_REGISTRY.md deployment-tracking.log
          
          if git diff --cached --quiet; then
            echo "No documentation changes to commit"
          else
            git commit -m "ðŸ“š Auto: Document changes from commit ${{ steps.commit-info.outputs.sha }}"
            git push origin main
          fi

      - name: âœ… Create Deployment Record
        run: |
          cat > deployment-record-${{ steps.commit-info.outputs.sha }}.json << 'EOF'
          {
            "timestamp": "${{ steps.commit-info.outputs.time }}",
            "commit_sha": "${{ steps.commit-info.outputs.sha }}",
            "commit_message": "${{ steps.commit-info.outputs.message }}",
            "author": "${{ steps.commit-info.outputs.author }}",
            "files_changed": ${{ toJSON(steps.changed-files.outputs.files) }},
            "status": "documented",
            "repository": "ahmdhk9/ai-programming-expert",
            "branch": "main"
          }
          EOF
          
          echo "âœ… Deployment record created"

      - name: ðŸ“¢ Output Summary
        run: |
          echo "=== ðŸ“š Documentation Summary ==="
          echo "Commit: ${{ steps.commit-info.outputs.sha }}"
          echo "Message: ${{ steps.commit-info.outputs.message }}"
          echo "Time: ${{ steps.commit-info.outputs.time }}"
          echo "Author: ${{ steps.commit-info.outputs.author }}"
          echo ""
          echo "âœ… Changes documented in:"
          echo "  - CHANGELOG.md"
          echo "  - DOCUMENTATION_REGISTRY.md"
          echo "  - deployment-tracking.log"
          echo "  - deployment-record-${{ steps.commit-info.outputs.sha }}.json"
