name: ðŸ”„ Auto-Track System - Monitor Everything

on:
  push:
    branches: [ main ]

jobs:
  auto-track:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: âœ… Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Analyze Commit
        id: analyze
        run: |
          # Get commit details
          COMMIT_SHA=$(git rev-parse HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_TIME=$(git log -1 --pretty=%aI)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          
          # Get files changed
          FILES=$(git diff-tree --no-commit-id --name-only -r HEAD | sort)
          FILE_COUNT=$(git diff-tree --no-commit-id --name-only -r HEAD | wc -l)
          
          # Analyze file types
          JS_FILES=$(echo "$FILES" | grep -c "\.js$" || true)
          MD_FILES=$(echo "$FILES" | grep -c "\.md$" || true)
          JSON_FILES=$(echo "$FILES" | grep -c "\.json$" || true)
          YML_FILES=$(echo "$FILES" | grep -c "\.yml$\|\.yaml$" || true)
          
          echo "sha=${COMMIT_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "message=${COMMIT_MSG}" >> $GITHUB_OUTPUT
          echo "time=${COMMIT_TIME}" >> $GITHUB_OUTPUT
          echo "author=${COMMIT_AUTHOR}" >> $GITHUB_OUTPUT
          echo "file_count=${FILE_COUNT}" >> $GITHUB_OUTPUT
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ðŸ¤– Detect Tools & Algorithms
        id: detect
        run: |
          TOOLS=""
          ALGORITHMS=""
          
          FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)
          
          # Detect Node.js usage
          if echo "$FILES" | grep -q "\.js$"; then
            if grep -r "https.request" . --include="*.js" 2>/dev/null | head -1 | grep -q .; then
              TOOLS="$TOOLSâ€¢ Node.js HTTPS API\n"
            fi
            if grep -r "class " . --include="*.js" 2>/dev/null | head -1 | grep -q .; then
              ALGORITHMS="$ALGORITHMSâ€¢ Classes/OOP\n"
            fi
          fi
          
          # Detect GitHub Actions
          if echo "$FILES" | grep -q "\.github/workflows"; then
            TOOLS="$TOOLSâ€¢ GitHub Actions\n"
          fi
          
          # Detect bash/shell
          if echo "$FILES" | grep -q "\.sh$"; then
            TOOLS="$TOOLSâ€¢ Bash Shell\n"
          fi
          
          echo "tools<<EOF" >> $GITHUB_OUTPUT
          echo -e "$TOOLS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "algorithms<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ALGORITHMS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ðŸ“š Update Central Source
        run: |
          cat >> CENTRAL_TRACKING.log << 'TRACK'
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ðŸ“Š CENTRAL TRACKING RECORD
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Timestamp: ${{ steps.analyze.outputs.time }}
          Commit: ${{ steps.analyze.outputs.sha }}
          Author: ${{ steps.analyze.outputs.author }}
          Message: ${{ steps.analyze.outputs.message }}
          
          ðŸ“‹ Files Changed: ${{ steps.analyze.outputs.file_count }}
          ${{ steps.analyze.outputs.files }}
          
          ðŸ”§ Tools Used:
          ${{ steps.detect.outputs.tools }}
          
          ðŸ¤– Algorithms:
          ${{ steps.detect.outputs.algorithms }}
          
          ðŸŒ Status: âœ… Auto-Tracked
          ðŸ”— Source: GitHub Actions
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          TRACK

      - name: ðŸ“ Integrate with replit.md
        run: |
          # Create a tracking entry
          cat >> TRACKING_ENTRY.txt << 'ENTRY'
          
          ### Commit: ${{ steps.analyze.outputs.sha }}
          - **Date:** ${{ steps.analyze.outputs.time }}
          - **Author:** ${{ steps.analyze.outputs.author }}
          - **Files:** ${{ steps.analyze.outputs.file_count }}
          - **Status:** âœ… Auto-Tracked
          - **Source:** Central Source of Truth
          
          ENTRY

      - name: ðŸ”— Create Cross-References
        run: |
          # Link all sources
          cat > SOURCE_LINKS.md << 'LINKS'
          # ðŸ”— Cross-Reference Links
          
          ## Latest Tracking:
          - Commit: ${{ steps.analyze.outputs.sha }}
          - CHANGELOG: CHANGELOG.md
          - Registry: DOCUMENTATION_REGISTRY.md
          - Central: CENTRAL_TRACKING.log
          - Config: replit.md
          
          **All sources automatically synced**
          
          LINKS

      - name: âœ… Commit Auto-Tracking
        run: |
          git config user.name "System Auto-Track"
          git config user.email "system@autotrack.dev"
          
          git add CENTRAL_TRACKING.log SOURCE_LINKS.md
          
          if git diff --cached --quiet; then
            echo "No tracking updates"
          else
            git commit -m "ðŸ”„ Auto: System tracking for ${{ steps.analyze.outputs.sha }}"
            git push origin main 2>/dev/null || echo "Push skipped"
          fi

      - name: ðŸ“Š Generate Tracking Summary
        run: |
          cat > TRACKING_SUMMARY.json << 'JSON'
          {
            "tracking_system": "Central Source of Truth",
            "commit": "${{ steps.analyze.outputs.sha }}",
            "timestamp": "${{ steps.analyze.outputs.time }}",
            "author": "${{ steps.analyze.outputs.author }}",
            "files_changed": ${{ steps.analyze.outputs.file_count }},
            "tools_detected": ${{ steps.detect.outputs.tools }},
            "auto_tracked": true,
            "source": "GitHub Actions Auto-Track",
            "status": "âœ…"
          }
          JSON
          
          echo "âœ… Tracking Summary Generated"
          cat TRACKING_SUMMARY.json

      - name: ðŸŽ¯ Log to Central Source
        run: |
          echo "âœ… Central Source Updated"
          echo "ðŸ“Š Commit: ${{ steps.analyze.outputs.sha }}"
          echo "ðŸ“ Files: ${{ steps.analyze.outputs.file_count }}"
          echo "ðŸ”§ Tools: Auto-detected"
          echo "â° Time: ${{ steps.analyze.outputs.time }}"
          echo "ðŸ‘¤ Author: ${{ steps.analyze.outputs.author }}"
          echo ""
          echo "ðŸŽ¯ System Status: AUTO-TRACKING ENABLED"
