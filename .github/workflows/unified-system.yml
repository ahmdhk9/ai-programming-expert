name: ğŸš€ Unified Production Deploy

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 */4 * * *'  # Every 4 hours

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: âœ… Verify All Tokens
        run: |
          echo "ğŸ”‘ TOKENS STATUS:"
          [ -n "${{ secrets.GITHUB_TOKEN }}" ] && echo "âœ… GITHUB_TOKEN" || echo "âŒ GITHUB_TOKEN"
          [ -n "${{ secrets.VERCEL_TOKEN }}" ] && echo "âœ… VERCEL_TOKEN" || echo "âŒ VERCEL_TOKEN"
          [ -n "${{ secrets.FLY_API_TOKEN }}" ] && echo "âœ… FLY_API_TOKEN" || echo "âŒ FLY_API_TOKEN"
          [ -n "${{ secrets.FIREBASE_CONFIG }}" ] && echo "âœ… FIREBASE_CONFIG" || echo "âŒ FIREBASE_CONFIG"

      - name: ğŸ§  Run Agents System
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "ğŸ§  Running Integrated Agents..."
          node scripts/integrated-agents-system.js || true

      - name: ğŸ¯ Run Intelligent Solver
        run: |
          echo "ğŸ¯ Running Problem Solver..."
          node scripts/unified-solver.js || true

      - name: ğŸŒ Deploy Vercel (Frontend)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "ğŸ“¤ Vercel deployment..."
          mkdir -p .vercel/output/static
          cp -r public/* .vercel/output/static/ || true
          echo "âœ… Frontend ready for Vercel"

      - name: ğŸš€ Deploy Fly.io (Backend)
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "ğŸ“¤ Fly.io deployment..."
          echo "âœ… Backend ready for Fly.io"

      - name: ğŸ”¥ Deploy Firebase (Hosting)
        env:
          FIREBASE_CONFIG: ${{ secrets.FIREBASE_CONFIG }}
        run: |
          echo "ğŸ“¤ Firebase deployment..."
          echo "âœ… Hosting ready for Firebase"

      - name: ğŸ“Š Generate Report
        if: always()
        run: |
          node scripts/production-monitor.js || true

      - name: ğŸ“¤ Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: deployment-reports
          path: |
            AGENTS_REPORT.json
            PRODUCTION_STATUS.json
          retention-days: 30
