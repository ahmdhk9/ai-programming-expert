app = "agent-backend-ahmd1"   # اسم التطبيق على Fly.io

[build]
  builder = "heroku/buildpacks:20"   # نستخدم Buildpack جاهز للـ Node.js
  buildpacks = ["heroku/nodejs"]     # نحدد صراحةً إنه Node.js مو Next.js

[env]
  NODE_ENV = "production"            # نخلي البيئة Production

[deploy]
  release_command = "npm install --prefix backend"  
  # هنا التعديل الأول: نوضح أن الـ npm install لازم يشتغل داخل مجلد backend/
  # مو بالجذر، لأن package.json موجود داخل backend/

[processes]
  app = "npm start --prefix backend" 
  # هنا التعديل الثاني: نوضح أن التشغيل (start) لازم يكون من مجلد backend/
  # هذا يمنع Fly.io من محاولة تشغيل "yarn build" في الجذر

[[services]]
  internal_port = 3000               # البورت اللي السيرفر يسمع عليه
  protocol = "tcp"

  [[services.ports]]
    handlers = ["http"]
    port = 80                        # فتح HTTP على البورت 80

  [[services.ports]]
    handlers = ["tls", "http"]
    port = 443                       # فتح HTTPS على البورت 443
